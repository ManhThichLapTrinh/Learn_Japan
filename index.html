<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kana Quiz – DemnKa</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="wrap">
    <h1>Kana Quiz <span class="neon">DemnKa</span></h1>
    <p class="lead">Luyện bảng chữ cái Nhật: <b>Hiragana</b> & <b>(Updated v0.4)Katakana</b>.</b></p>

    <!-- Sticky (Tiến độ + Đồng hồ) -->
    <div id="stickyBar" class="sticky">
      <div class="panel soft" id="metaBar" style="display:none">
        <div class="meta-row">
          <div class="meta-left">
            <div class="progress-wrap">
              <div class="progress-label">
                <span>Tiến độ</span>
                <span id="progressText">0/0</span>
              </div>
              <div class="progress">
                <div class="progress-bar" id="progressBar" style="width:0%"></div>
              </div>
            </div>
          </div>
          <div class="meta-right">
            <div class="timer">
              <span class="timer-label">Thời gian còn lại</span>
              <span class="timer-value" id="timer">--:--</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div class="panel grid cols-3" id="controls">
      <div>
        <label for="script">Bảng chữ</label>
        <select id="script">
          <option value="hira">Hiragana</option>
          <option value="kata" selected>Katakana</option>
          <option value="mix">Trộn (Hira + Kata)</option>
        </select>
      </div>

      <div>
        <label for="mode">Chế độ</label>
        <select id="mode">
          <option value="k2r">Kana → Romaji</option>
          <option value="r2k">Romaji → Kana</option>
          <option value="mix" selected>Mixed (trộn 2 chiều)</option>
        </select>
      </div>

      <div>
        <label for="qcount">Số câu</label>
        <select id="qcount">
          <option>20</option>
          <option selected>25</option>
          <option>30</option>
        </select>
      </div>

      <div>
        <label for="qtype">Kiểu làm bài</label>
        <select id="qtype">
          <option value="mc" selected>Trắc nghiệm (4 đáp án)</option>
          <option value="fill">Điền (tự gõ)</option>
        </select>
      </div>

      <div>
        <label for="seqLen">Độ dài chuỗi</label>
        <select id="seqLen">
          <option value="1" selected>1 (cơ bản)</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="1-3">1–3 ngẫu nhiên</option>
        </select>
      </div>

      <div>
        <label for="seed">Hạt giống (tùy chọn – để tái lập đề)</label>
        <input id="seed" type="number" placeholder="VD: 12345" />
      </div>

      <div>
        <label for="includeWo">Bao gồm を/ヲ (wo – đọc “o”)?</label>
        <select id="includeWo">
          <option value="yes" selected>Có</option>
          <option value="no">Không</option>
        </select>
      </div>

      <div>
        <label for="timeLimit">Thời gian (đồng hồ)</label>
        <select id="timeLimit">
          <option value="0" selected>Không giới hạn</option>
          <option value="300">5 phút</option>
          <option value="600">10 phút</option>
          <option value="900">15 phút</option>
        </select>
      </div>

      <div class="align-end">
        <button class="btn" id="gen">Tạo đề ngẫu nhiên</button>
      </div>
    </div>

    <!-- Actions -->
    <div class="toolbar" id="actions" style="display:none">
      <button class="btn ghost" id="revealAll">Hiện đáp án toàn bài</button>
      <button class="btn ghost" id="reset">Tạo đề mới</button>
      <span class="badge">Điểm: <span id="score" class="score">0</span></span>
      <button class="btn ghost" id="retryWrong" style="display:none">Làm lại câu sai</button>
      <button class="btn ghost" id="exportResult" style="display:none">Xuất kết quả</button>
    </div>

    <!-- Quiz container -->
    <div id="quiz" class="grid" style="margin-top:16px;gap:12px"></div>

    <!-- Nút chấm điểm ở CUỐI bài -->
    <div style="margin-top:20px;text-align:center;display:none" id="checkWrap">
      <button class="btn" id="check">Chấm điểm</button>
    </div>

    <!-- Kết quả -->
    <div id="result" class="panel result" style="display:none;margin-top:12px"></div>

    <!-- Footer -->
    <div class="footer">
      <span>© <span id="year"></span> · Tạo bởi <strong>TuanManh</strong></span>
    </div>
  </div>

  <!-- Floating presence (góc dưới màn hình) -->
  <div class="presence" id="presenceBox">
    <span class="presence-dot"></span>
    Đang online: <b id="onlineCount">—</b>
  </div>

  <script src="app.js"></script>

  <!-- Firebase Presence (đếm số online, dùng Realtime Database) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getDatabase, ref, onValue, onDisconnect, set, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // Cấu hình Firebase của bạn
    const firebaseConfig = {
      apiKey: "AIzaSyBfS5Iv2DzOh6lvV1yQsF9G7rsLkSksyeQ",
      authDomain: "learn-japan-7270d.firebaseapp.com",
      databaseURL: "https://learn-japan-7270d-default-rtdb.firebaseio.com",
      projectId: "learn-japan-7270d",
      storageBucket: "learn-japan-7270d.appspot.com",
      messagingSenderId: "396837788671",
      appId: "1:396837788671:web:75495079b66d9dfcada5ca",
      measurementId: "G-B3XP64MWP7"
    };

    // Khởi tạo
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // Tạo session cho mỗi tab
    const sessionId = `s_${crypto.getRandomValues(new Uint32Array(1))[0].toString(16)}_${Date.now()}`;
    const sessRef   = ref(db, `presence/${sessionId}`);

    // Ghi hiện diện
    await set(sessRef, {
      ts: serverTimestamp(),
      ua: navigator.userAgent.slice(0, 120)
    });

    // Xoá khi tab đóng/mất kết nối
    onDisconnect(sessRef).remove();

    // Đếm online
    const presenceRoot = ref(db, "presence");
    const onlineCountEl = document.getElementById("onlineCount");
    onValue(presenceRoot, (snap) => {
      const val = snap.val() || {};
      const count = Object.keys(val).length;
      if (onlineCountEl) onlineCountEl.textContent = String(count);
    });
  </script>
</body>
</html>
